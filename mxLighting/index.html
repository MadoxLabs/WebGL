<html>
<head>
<title>Madoxlabs Lighting Experimenter</title>
  <link rel="stylesheet" href="css/style.css" media="screen" type="text/css" />
  <script src="js/tga.js"></script>
  <script src="../mxFrame/mxFrame.js"></script>
  <script>
    var animImage;
    var staticImage;

    function init()
    {
      window.onresize();
      animImage = new Image();
      animImage.src = "assets/animatedlogo.gif";
      staticImage = new Image();
      staticImage.src = "assets/logo.jpg";

      addModel("sample");

      var texDrop = document.getElementById('texDrop');
      texDrop.addEventListener('dragover', handleDragOver, false);
      texDrop.addEventListener('drop', handleTexDrop, false);

      var modelDrop = document.getElementById('modelDrop');
      modelDrop.addEventListener('dragover', handleDragOver, false);
      modelDrop.addEventListener('drop', handleModelDrop, false);

      var lightClick = document.getElementById('lightClick');
      lightClick.onclick = handleNewLight;
    }

    function addModel(name)
    {
      document.getElementById("listModels").innerHTML += "<div onclick='selectModel(\"" + name + "\");'><p style='cursor: pointer;'>" + name + "</p></div>"
    }

    function selectModel(name)
    {
      modelName = name;
      if (name == 'sample')
        Game.loadMeshPNG("sample", "assets/sample.model"); // special case, its a file
      else
      {        
        Game.loadingIncr();
        var tex = new mx.MeshPNG(name);
        tex.load(models[name]);
      }
    }

    function selectLight(n)
    {
      Game.pickLight(n); // array starts at 0
      listLights();
      document.getElementById("lightEdit").style.visibility = pickedLight ? "visible" : "hidden";
      if (pickedLight)
      {
        document.getElementById("lightAmbient").value = pickedLight.ambientFactor;
        document.getElementById("lightAttenuation").value = pickedLight.attenuation;
        document.getElementById("lightColorR").value = pickedLight.color[0];
        document.getElementById("lightColorG").value = pickedLight.color[1];
        document.getElementById("lightColorB").value = pickedLight.color[2];
      }
    }

    function updateLight()
    {
      pickedLight.ambientFactor = document.getElementById("lightAmbient").value;
      pickedLight.attenuation = document.getElementById("lightAttenuation").value;
      pickedLight.color[0] = document.getElementById("lightColorR").value;
      pickedLight.color[1] = document.getElementById("lightColorG").value;
      pickedLight.color[2] = document.getElementById("lightColorB").value;
      Game.updateLightUniform(pickedLight);
    }

    function removeLight(n)
    {
      Game.removeLight(n);
      listLights();
      document.getElementById("lightEdit").style.visibility = pickedLight ? "visible" : "hidden";
    }

    function listLights()
    {
      var buf = "<table>";
      for (var i in lamps)
        buf += "<tr><td><div onclick='removeLight(\"" + i + "\");'><p style='cursor: pointer;'>-</p></div></td><td><div " + (lamps[i].selected ? "style=\"background:#aaa\"" : "") + " onclick='selectLight(\"" + i + "\");'><p style='cursor: pointer;'> Light " + i + "</p></div></td></tr>";
      document.getElementById("listLights").innerHTML = buf + "</table>";
    }

    function handleDragOver(evt)
    {
      evt.stopPropagation();
      evt.preventDefault();
      evt.dataTransfer.dropEffect = 'copy';
    }

    var impTextures = {};
    var models = {};

    function handleNewLight()
    {
      Game.addLight();
      listLights();
    }

    function handleModelDrop(evt)
    {
      evt.stopPropagation();
      evt.preventDefault();

      var files = evt.dataTransfer.files;
      for (var f = 0; f < files.length; ++f)
      {
        if (!files[f].name) continue;
        var parts = files[f].name.split(".");
        var name = parts[parts.length - 2];
        addModel(name);
        var reader = new FileReader();
        reader.onload = function (name)
        {
          return function (e)
          {
            models[name] = e.target.result;
          }
        }(name);
        reader.readAsDataURL(files[f]);
      }
    }

    function handleTexDrop(evt)
    {
      evt.stopPropagation();
      evt.preventDefault();

      var files = evt.dataTransfer.files;
      for (var i = 0, f; f = files[i]; ++i)
      {
        if (!f.name) continue;
        var parts = f.name.split(".");
        var name = parts[parts.length - 2];
        impTextures[name] = { color: "white" };
        var buf = "";
        for (var n in impTextures) buf += "<p style='color: " + impTextures[n].color + "'>" + n + "</p>"
        document.getElementById("listTextures").innerHTML = buf;

        if (parts[parts.length - 1] == "tga")
        {
          var reader = new FileReader();
          reader.onload = function (name) { return function (e) { loadTGATexture(name, e.target.result); } }(name);
          reader.readAsArrayBuffer(f);
        }
        else
        {
          var reader = new FileReader();
          reader.onload = function (name) { return function (e) { loadTexture(name, e.target.result); } }(name);
          reader.readAsDataURL(f);
        }
      }
    }

    function loadTexture(name, data)
    {
      loadingTextures = true;
      Game.loadTextureData(name, data, true);
    }

    function loadTGATexture(name, data)
    {
      var tga_data = new Uint8Array(data);
      var tga = new TGA();
      tga.load(tga_data);
      data = tga.getDataURL('image/png');

      loadingTextures = true;
      Game.loadTextureData(name, data, true);
    }

    window.onresize = function()
    {
      document.getElementById("viewer").style.width = window.innerWidth - 200;
    }
  </script>
</head>
<body onload="init(); mx.loadApp(['js/viewer.js'], '../mxFrame', mx.WITH_MXFRAME|mx.WITH_OCULUS|mx.WITH_TOUCH);">
  <div id='header'><img onmouseover="this.src=animImage.src;" onmouseout="this.src=staticImage.src;" src="assets/logo.jpg"></div>
  <div id="btnView" class="mxButton active">Viewer</div>
  <br />
  <div id="models" class="importControl sidebar"><center><p>Recent Models</p><div id="modelDrop">Drop models here</div></center><div id="listModels"></div></div>
  <br />
  <div id="textures" class="importControl sidebar"><center><p>Textures</p><div id="texDrop">Drop files here</div></center><div id="listTextures"></div></div>
  <br />
  <div id="newlight" class="importControl sidebar"><center><p>Lights</p><div id="lightClick">Add light source</div></center><div id="listLights"></div></div>
  <div id="edge"></div>
  <div class="top" id="mover"></div>

  <div id="viewer" class="appwindow">
    <div class="mxTitle">Lighting Experimenter</div>
    <div><canvas style="width:100%; height:100%;" id='surface'></div>
    <div style="top:55px; left:5px; position:absolute;"><canvas id='output' width="400" height="50"></div>
    <div id="lightEdit" class="importControl" style="top:55px; left:5px; position:absolute;">
    Ambient Factor: <input size="2" id="lightAmbient" /><br />
    Attenuation:<input size="2" id="lightAttenuation" /><br />
    Color:<input size="2" id="lightColorR" /><input size="2" id="lightColorG" /><input size="2" id="lightColorB" /><br />
    <button onclick="updateLight()">Update</button>
    </div>
  </div>
</body>
</html>


<!-- 
  
  light controls - to see what setting affect
  add a light - arange up to 10 light in a circle
  mouse controls
  click light to modify or modify all
  remove light
  shadows - multi shadows, look into the shadow baking  thing
   -->